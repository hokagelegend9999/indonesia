#!/bin/bash

# --- Variabel Warna ---
GREEN="\e[92;1m"
RED="\033[31m"
YELLOW="\033[33m"
BLUE="\033[36m"
FONT="\033[0m"
OK="${GREEN}--->${FONT}"
ERROR="${RED}[ERROR]${FONT}"
NC='\e[0m' # No Color

# --- Fungsi Pembantu ---
print_success() {
    echo -e "${GREEN}===============================${FONT}"
    echo -e "${OK} $1 berhasil diproses."
    echo -e "${GREEN}===============================${FONT}"
    sleep 0.5
}

print_uninstall() {
    echo -e "${BLUE}===============================${FONT}"
    echo -e "${YELLOW}# Memproses: $1 ${FONT}"
    echo -e "${BLUE}===============================${FONT}"
    sleep 0.5
}

# --- Proses Utama ---
clear
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo -e "         SELAMAT DATANG DI HOKAGE LEGEND STORE VPN UNINSTALLER"
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo -e " Skrip ini akan menghapus semua layanan VPN/proxy dan konfigurasinya,"
echo -e " **tetapi akan memastikan SSH tetap berfungsi**."
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo ""

# Memastikan skrip dijalankan sebagai root
if [ "${EUID}" -ne 0 ]; then
    echo -e "${ERROR} Anda harus menjalankan skrip ini sebagai ${RED}root${FONT}. Silakan gunakan ${YELLOW}sudo ./uninstall_vpn.sh${FONT}."
    exit 1
fi

read -p "$( echo -e "Tekan ${BLUE}[ ${NC}${GREEN}Enter${NC} ${BLUE}]${NC} untuk memulai proses uninstal, atau ${RED}Ctrl+C${FONT} untuk membatalkan.") "
echo ""

echo -e "${BLUE}Memulai proses uninstal...${NC}"
echo ""

# --- 1. Menghentikan dan Menonaktifkan Layanan ---
print_uninstall "Menghentikan dan menonaktifkan layanan"

SERVICES=(
    "nginx" "xray" "haproxy" "dropbear" "openvpn" "fail2ban" "vnstat"
    "udp-mini-1" "udp-mini-2" "udp-mini-3" "ws" "noobzvpns"
)

for svc in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$svc"; then
        echo -e "  ${YELLOW}*${FONT} Menghentikan $svc..."
        systemctl stop "$svc" &>/dev/null
    fi
    if systemctl is-enabled --quiet "$svc"; then
        echo -e "  ${YELLOW}*${FONT} Menonaktifkan $svc..."
        systemctl disable "$svc" &>/dev/null
    fi
done

print_success "Layanan dihentikan dan dinonaktifkan"

# --- 2. Menghapus Cron Jobs ---
print_uninstall "Menghapus Cron jobs"
rm -f /etc/cron.d/{xp_all,logclean,daily_reboot,limit_ip,lim-ip-ssh,limit_ip2,log.nginx,log.xray} &>/dev/null
print_success "Cron jobs"

# --- 3. Menghapus Paket Aplikasi ---
print_uninstall "Menghapus paket aplikasi dan dependensi"

PACKAGES=(
    "haproxy" "nginx" "xray" "dropbear" "openvpn" "vnstat" "wondershaper"
    "rclone" "msmtp-mta" "fail2ban" "figlet" "lolcat" "socat"
    "netcat-openbsd" "easy-rsa" "jq" "shc" "noobzvpns"
)

for pkg in "${PACKAGES[@]}"; do
    echo -e "  ${YELLOW}*${FONT} Menghapus paket $pkg..."
    apt-get purge --auto-remove -y "$pkg" &>/dev/null
done
apt-get autoremove -y &>/dev/null
apt-get clean -y &>/dev/null
print_success "Paket aplikasi"

# --- 4. Menghapus File dan Direktori Terkait ---
print_uninstall "Menghapus file dan direktori konfigurasi"

DIRECTORIES=(
    "/etc/xray" "/var/log/xray" "/var/lib/kyt" "/etc/haproxy" "/root/.acme.sh"
    "/etc/vmess" "/etc/vless" "/etc/trojan" "/etc/shadowsocks" "/etc/bot"
    "/var/www/html" "/etc/kyt/limit" "/etc/limit" "/etc/user-create"
    "/usr/local/kyt" "/usr/local/ddos" "/root/.config/rclone" "/home/limit"
    "/root/.info" "/etc/systemd/system/xray.service.d" "/usr/local/share/xray"
    "/usr/local/sbin" "/usr/local/bin" "/usr/local/etc"
)

FILES=(
    "/etc/nginx/conf.d/xray.conf" "/etc/nginx/nginx.conf" "/swapfile" "/etc/msmtprc"
    "/etc/ipserver" "/etc/systemd/system/runn.service" "/etc/systemd/system/xray.service"
    "/etc/systemd/system/udp-mini-1.service" "/etc/systemd/system/udp-mini-2.service"
    "/etc/systemd/system/udp-mini-3.service" "/etc/systemd/system/ws.service"
    "/etc/systemd/system/noobzvpns.service" "/tmp/nameserver" "/etc/kyt.txt"
    "/usr/bin/ws" "/usr/bin/tun.conf" "/usr/sbin/ftvpn" "/usr/bin/user"
    "/usr/bin/e" "/usr/bin/xray" "/bin/wondershaper" "/root/install.log"
    "/root/log-install.txt" "/root/openvpn" "/root/key.pem" "/root/cert.pem"
)

# Hapus direktori dengan logging error
for dir in "${DIRECTORIES[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "  ${YELLOW}*${FONT} Menghapus atribut terkunci dari $dir..."
        chattr -R -i "$dir" &>/dev/null
        echo -e "  ${YELLOW}*${FONT} Menghapus direktori $dir..."
        rm -rf "$dir"
        if [ $? -ne 0 ]; then
            echo -e "  ${ERROR} Gagal menghapus direktori $dir. Periksa galat di atas."
        else
            echo -e "  ${OK} Direktori $dir berhasil dihapus."
        fi
    fi
done

# Hapus file individual
for file in "${FILES[@]}"; do
    if [ -f "$file" ]; an
        echo -e "  ${YELLOW}*${FONT} Menghapus atribut terkunci dari $file..."
        chattr -i "$file" &>/dev/null
        echo -e "  ${YELLOW}*${FONT} Menghapus file $file..."
        rm -f "$file" &>/dev/null
    fi
done

print_success "File dan direktori konfigurasi"

# --- 5. Memulihkan Konfigurasi Sistem Dasar ---
print_uninstall "Memulihkan konfigurasi sistem dasar"

# Pulihkan /etc/pam.d/common-password
if [ -f /etc/pam.d/common-password.bak ]; then
    mv /etc/pam.d/common-password.bak /etc/pam.d/common-password &>/dev/null
    echo -e "  ${OK} /etc/pam.d/common-password dipulihkan."
else
    echo -e "  ${YELLOW}Peringatan: Cadangan /etc/pam.d/common-password tidak ditemukan.${NC}"
fi

# Bersihkan /etc/rc.local
sed -i '/iptables/d' /etc/rc.local &>/dev/null
sed -i '/systemctl restart netfilter-persistent/d' /etc/rc.local &>/dev/null
sed -i '/disable_ipv6/d' /etc/rc.local &>/dev/null
echo -e "  ${OK} /etc/rc.local dibersihkan."

# Bersihkan konfigurasi SSH
sed -i '/^Banner \/etc\/kyt.txt/d' /etc/ssh/sshd_config &>/dev/null
sed -i 's@DROPBEAR_BANNER="/etc/kyt.txt"@DROPBEAR_BANNER=""@g' /etc/default/dropbear &>/dev/null
echo -e "  ${OK} Banner SSH dan Dropbear dihapus."

print_success "Konfigurasi sistem dasar"

# --- 6. Membersihkan Aturan IPTables ---
print_uninstall "Membersihkan aturan iptables"
{
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X
    netfilter-persistent save
    netfilter-persistent reload
} &>/dev/null
echo -e "  ${OK} Aturan iptables telah direset."
print_success "Aturan iptables"

# --- 7. Membersihkan Sisa File Skrip ---
print_uninstall "Membersihkan sisa file skrip"
rm -f /root/*.zip /root/*.sh /root/LICENSE /root/README.md /root/domain &>/dev/null
print_success "Sisa file skrip"

# --- 8. Finalisasi ---
print_uninstall "Finalisasi dan restart SSH"
systemctl restart ssh &>/dev/null
echo -e "  ${OK} Layanan SSH di-restart."

history -c
echo "unset HISTFILE" >> /etc/profile
print_success "Pembersihan akhir"

echo ""
echo -e "${GREEN}----------------------------------------------------------${NC}"
echo -e "                  PROSES UNINSTALL SELESAI!"
echo -e " Semua layanan VPN/proxy dan konfigurasinya telah dihapus."
echo -e "                  ${GREEN}Akses SSH Anda tetap aktif.${NC}"
echo -e "${GREEN}----------------------------------------------------------${NC}"
echo ""
echo "Sangat disarankan untuk melakukan ${YELLOW}reboot VPS${FONT} Anda sekarang."
read -p "$( echo -e "Tekan ${BLUE}[ ${NC}${GREEN}Enter${NC} ${BLUE}]${NC} untuk ${GREEN}reboot${NC}, atau ${RED}Ctrl+C${FONT} untuk membatalkan.") "
reboot
