#!/bin/bash

# --- Variabel Warna ---
GREEN="\e[92;1m"
RED="\033[31m"
YELLOW="\033[33m"
BLUE="\033[36m"
FONT="\033[0m"
OK="${GREEN}--->${FONT}"
ERROR="${RED}[ERROR]${FONT}"
NC='\e[0m' # No Color

# --- Fungsi Pembantu ---
print_success() {
    echo -e "${GREEN}===============================${FONT}"
    echo -e "${OK} $1 berhasil diproses."
    echo -e "${GREEN}===============================${FONT}"
    sleep 0.5
}

print_uninstall() {
    echo -e "${BLUE}===============================${FONT}"
    echo -e "${YELLOW}# Memproses: $1 ${FONT}"
    echo -e "${BLUE}===============================${FONT}"
    sleep 0.5
}

# --- Proses Utama ---
clear
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo -e "         SELAMAT DATANG DI HOKAGE LEGEND STORE VPN UNINSTALLER (FINAL)"
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo -e " Skrip ini akan menghapus semua layanan VPN/proxy dan konfigurasinya,"
echo -e " **dan akan mencoba mematikan paksa proses yang terkunci**."
echo -e "${YELLOW}----------------------------------------------------------${NC}"
echo ""

# Memastikan skrip dijalankan sebagai root
if [ "${EUID}" -ne 0 ]; then
    echo -e "${ERROR} Anda harus menjalankan skrip ini sebagai ${RED}root${FONT}. Silakan gunakan ${YELLOW}sudo ./uninstall_vpn.sh${FONT}."
    exit 1
fi

read -p "$( echo -e "Tekan ${BLUE}[ ${NC}${GREEN}Enter${NC} ${BLUE}]${NC} untuk memulai, atau ${RED}Ctrl+C${FONT} untuk batal.") "
echo ""

echo -e "${BLUE}Memulai proses uninstal...${NC}"
echo ""

# --- 1. Menghentikan Layanan Systemd ---
print_uninstall "Menghentikan layanan Systemd"
SERVICES=(
    "nginx" "xray" "haproxy" "dropbear" "openvpn" "fail2ban" "vnstat"
    "udp-mini-1" "udp-mini-2" "udp-mini-3" "ws" "noobzvpns"
)
for svc in "${SERVICES[@]}"; do
    if systemctl is-active --quiet "$svc"; then
        echo -e "  ${YELLOW}*${FONT} Menghentikan $svc..."
        systemctl stop "$svc" &>/dev/null
    fi
    if systemctl is-enabled --quiet "$svc"; then
        echo -e "  ${YELLOW}*${FONT} Menonaktifkan $svc..."
        systemctl disable "$svc" &>/dev/null
    fi
done
print_success "Layanan Systemd"

# --- 2. Mematikan Paksa Proses yang Terkunci ---
print_uninstall "Mematikan paksa proses yang berjalan dari /usr/local/"
TARGET_DIRS=("/usr/local/sbin" "/usr/local/bin")
for dir in "${TARGET_DIRS[@]}"; do
    echo "Mencari proses di direktori: $dir"
    # Cari PID dari proses yang executablenya ada di dalam direktori target
    PIDS=$(lsof +D "$dir" | awk 'NR>1 {print $2}' | sort -u)
    if [ -n "$PIDS" ]; then
        for pid in $PIDS; do
            echo -e "  ${RED}*${FONT} Ditemukan proses terkunci dengan PID: $pid. Mematikan paksa..."
            kill -9 "$pid" &>/dev/null
        done
    else
        echo "  ${GREEN}*${FONT} Tidak ada proses aktif yang ditemukan di $dir."
    fi
done
print_success "Proses terkunci"

# --- 3. Menghapus Cron & Paket ---
print_uninstall "Menghapus Cron jobs dan Paket Aplikasi"
rm -f /etc/cron.d/{xp_all,logclean,daily_reboot,limit_ip,lim-ip-ssh,limit_ip2,log.nginx,log.xray} &>/dev/null
PACKAGES=(
    "haproxy" "nginx" "xray" "dropbear" "openvpn" "vnstat" "wondershaper"
    "rclone" "msmtp-mta" "fail2ban" "figlet" "lolcat" "socat"
    "netcat-openbsd" "easy-rsa" "jq" "shc" "noobzvpns" "lsof"
)
apt-get purge --auto-remove -y "${PACKAGES[@]}" &>/dev/null
apt-get autoremove -y &>/dev/null
apt-get clean &>/dev/null
print_success "Cron & Paket"

# --- 4. Menghapus File dan Direktori Terkait ---
print_uninstall "Menghapus file dan direktori konfigurasi"
DIRECTORIES=(
    "/etc/xray" "/var/log/xray" "/var/lib/kyt" "/etc/haproxy" "/root/.acme.sh"
    "/etc/vmess" "/etc/vless" "/etc/trojan" "/etc/shadowsocks" "/etc/bot"
    "/var/www/html" "/etc/kyt/limit" "/etc/limit" "/etc/user-create"
    "/usr/local/kyt" "/usr/local/ddos" "/root/.config/rclone" "/home/limit"
    "/root/.info" "/etc/systemd/system/xray.service.d" "/usr/local/share/xray"
    "/usr/local/sbin" "/usr/local/bin" "/usr/local/etc"
)
for dir in "${DIRECTORIES[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "  ${YELLOW}*${FONT} Memproses penghapusan untuk: $dir"
        chattr -R -i "$dir"
        rm -rf "$dir"
    fi
done
print_success "File & Direktori"

# --- 5. Verifikasi Penghapusan ---
print_uninstall "Verifikasi penghapusan /usr/local/sbin"
if [ -d "/usr/local/sbin" ] && [ "$(ls -A /usr/local/sbin)" ]; then
    echo -e "${ERROR} Gagal menghapus file di /usr/local/sbin secara otomatis."
    echo -e "${YELLOW} Masalah ini lebih dalam dari yang diperkirakan. Mungkin ada modul kernel atau proses rootkit."
    echo -e " Silakan coba hapus manual dengan 'rm -rf /usr/local/sbin/*' dan periksa log sistem.${NC}"
else
    echo -e "${OK} Direktori /usr/local/sbin berhasil dibersihkan."
fi
print_success "Verifikasi Selesai"

# --- 6. Pemulihan & Pembersihan Akhir ---
print_uninstall "Memulihkan konfigurasi sistem & pembersihan akhir"
# Hapus banner dari SSH & Dropbear
sed -i '/^Banner \/etc\/kyt.txt/d' /etc/ssh/sshd_config &>/dev/null
sed -i 's@DROPBEAR_BANNER="/etc/kyt.txt"@DROPBEAR_BANNER=""@g' /etc/default/dropbear &>/dev/null
# Flush Iptables
iptables-save | grep -v '^\*' | grep -v '^\:' | iptables-restore &>/dev/null
# Restart SSH & bersihkan history
systemctl restart ssh &>/dev/null
history -c && echo "" > ~/.bash_history
print_success "Sistem dibersihkan"

echo ""
echo -e "${GREEN}----------------------------------------------------------${NC}"
echo -e "                  PROSES UNINSTALL SELESAI!"
echo -e "                  ${GREEN}Akses SSH Anda tetap aktif.${NC}"
echo -e "${GREEN}----------------------------------------------------------${NC}"
echo ""
echo "Sangat disarankan untuk melakukan ${YELLOW}reboot VPS${FONT} Anda sekarang."
read -p "$( echo -e "Tekan ${BLUE}[ ${NC}${GREEN}Enter${NC} ${BLUE}]${NC} untuk ${GREEN}reboot${NC}, atau ${RED}Ctrl+C${FONT} untuk batal.") "
reboot
